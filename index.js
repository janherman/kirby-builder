(function () {function o(a){return a&&a.__esModule?{d:a.default}:{d:a}}function k(t){return(k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function l(t,e){return s(t)||r(t,e)||q()}function q(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function r(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var n=[],i=!0,o=!1,r=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(s){o=!0,r=s}finally{try{i||null==l.return||l.return()}finally{if(o)throw r}}return n}}function s(t){if(Array.isArray(t))return t}var a={data:function(){return{previewFrameWindow:{},previewFrameDocument:{},previewHeight:0}},props:{markup:{type:String},styles:{type:String},script:{type:String},cssContent:{type:String},index:{type:Number}},mounted:function(){this.$root.$on("blockMoved",this.updateFrameIfEmpty),this.previewFrameWindow=this.$refs.previewFrame.contentWindow,this.previewFrameDocument=this.previewFrameWindow.document,this.updateContent();var e=document.createElement("script");if(e.type="text/javascript",e.innerHTML="\n      sendResizeEvent = function () {\n        if (window.frameElement) {\n          window.frameElement.dispatchEvent(new CustomEvent('sizechange', { detail: { height: document.documentElement.offsetHeight } }))\n        }\n      }\n      sendResizedEvent = function () {\n        console.log('on resize')\n      }\n    ",this.previewFrameDocument.getElementsByTagName("body")[0].appendChild(e),this.updateContent(),this.script){var t=document.createElement("script");t.type="text/javascript",t.innerHTML=this.script,this.previewFrameDocument.getElementsByTagName("body")[0].appendChild(t)}},methods:{updateContent:function(){var e=this;this.$nextTick().then(function(){e.$refs.previewFrame&&(e.previewFrameWindow=e.$refs.previewFrame.contentWindow,e.previewFrameDocument=e.previewFrameWindow.document,e.previewFrameDocument.open(),e.previewFrameDocument.write(e.$refs.previewFrameContent.innerHTML),e.previewFrameDocument.close(),e.resize())})},updateFrameIfEmpty:function(){var e=this;this.$nextTick().then(function(){e.$refs.previewFrame&&null===e.$refs.previewFrame.contentWindow.document.getElementById("kirby-builder-content")&&e.updateContent()})},onResize:function(e){this.resize()},resize:function(){if(this.previewFrameDocument.getElementById){var e=this.previewFrameDocument.getElementById("kirby-builder-content").scrollHeight;e>0&&(this.previewHeight=e)}},onFrameLoad:function(){this.resize()}},watch:{markup:function(e){this.updateContent()},styles:function(e){this.updateContent()},index:function(e){this.updateFrameIfEmpty()}}};if(typeof a==="function"){a=a.options}Object.assign(a,function(){var render=function(){var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c("div",{staticClass:"kBuilderPreview"},[_c("iframe",{ref:"previewFrame",staticClass:"kBuilderPreview__frame",style:{height:_vm.previewHeight+"px"},on:{"load":_vm.onFrameLoad,"sizechange":_vm.onResize}}),_vm._v(" "),_c("script",{ref:"previewFrameContent",attrs:{"type":"text/template"}},[_vm._v("\n    <html lang=\"en\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\">\n        <title>Kirby Builder Preview</title>\n        <style>\n          html,body{margin: 0;padding: 0;}\n          "+_vm._s(_vm.styles)+"\n        </style>\n      </head>\n      <body>\n        <div id=\"kirby-builder-content\">\n          "+_vm._s(_vm.markup)+"\n        </div>\n      </body>\n    </html>\n  ")])])};var staticRenderFns=[];return{render:render,staticRenderFns:staticRenderFns,_compiled:true,_scopeId:"data-v-e4a91c",functional:undefined}}());var g,h={},t=arguments[0];!function(e,t){"object"==typeof h?h=t():"function"==typeof g&&g.amd?g(t):(e=e||self).Mustache=t()}(h,function(){var e=Object.prototype.toString,t=Array.isArray||function(t){return"[object Array]"===e.call(t)};function r(e){return"function"==typeof e}function n(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function i(e,t){return null!=e&&"object"==typeof e&&t in e}var o=RegExp.prototype.test;var a=/\S/;function s(e){return!function(e,t){return o.call(e,t)}(a,e)}var u={"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};var p=/\s*/,c=/\s+/,l=/\s*=/,h=/\s*\}/,f=/#|\^|\/|>|\{|&|=|!/;function v(e){this.string=e,this.tail=e,this.pos=0}function d(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function g(){this.cache={}}v.prototype.eos=function(){return""===this.tail},v.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r},v.prototype.scanUntil=function(e){var t,r=this.tail.search(e);switch(r){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,r),this.tail=this.tail.substring(r);}return this.pos+=t.length,t},d.prototype.push=function(e){return new d(e,this)},d.prototype.lookup=function(e){var t,n,o,a=this.cache;if(a.hasOwnProperty(e))t=a[e];else{for(var s,u,p,c=this,l=!1;c;){if(e.indexOf(".")>0)for(s=c.view,u=e.split("."),p=0;null!=s&&p<u.length;)p===u.length-1&&(l=i(s,u[p])||(n=s,o=u[p],null!=n&&"object"!=typeof n&&n.hasOwnProperty&&n.hasOwnProperty(o))),s=s[u[p++]];else s=c.view[e],l=i(c.view,e);if(l){t=s;break}c=c.parent}a[e]=t}return r(t)&&(t=t.call(this.view)),t},g.prototype.clearCache=function(){this.cache={}},g.prototype.parse=function(e,r){var i=this.cache,o=e+":"+(r||w.tags).join(":"),a=i[o];return null==a&&(a=i[o]=function(e,r){if(!e)return[];var i,o,a,u=!1,d=[],g=[],y=[],$=!1,U=!1,b="",x=0;function k(){if($&&!U)for(;y.length;)delete g[y.pop()];else y=[];$=!1,U=!1}function m(e){if("string"==typeof e&&(e=e.split(c,2)),!t(e)||2!==e.length)throw new Error("Invalid tags: "+e);i=new RegExp(n(e[0])+"\\s*"),o=new RegExp("\\s*"+n(e[1])),a=new RegExp("\\s*"+n("}"+e[1]))}m(r||w.tags);for(var E,j,T,Z,C,P,S=new v(e);!S.eos();){if(E=S.pos,T=S.scanUntil(i))for(var V=0,O=T.length;V<O;++V)s(Z=T.charAt(V))?(y.push(g.length),b+=Z):(U=!0,u=!0,b+=" "),g.push(["text",Z,E,E+1]),E+=1,"\n"===Z&&(k(),b="",x=0,u=!1);if(!S.scan(i))break;if($=!0,j=S.scan(f)||"name",S.scan(p),"="===j?(T=S.scanUntil(l),S.scan(l),S.scanUntil(o)):"{"===j?(T=S.scanUntil(a),S.scan(h),S.scanUntil(o),j="&"):T=S.scanUntil(o),!S.scan(o))throw new Error("Unclosed tag at "+S.pos);if(C=">"==j?[j,T,E,S.pos,b,x,u]:[j,T,E,S.pos],x++,g.push(C),"#"===j||"^"===j)d.push(C);else if("/"===j){if(!(P=d.pop()))throw new Error("Unopened section \""+T+"\" at "+E);if(P[1]!==T)throw new Error("Unclosed section \""+P[1]+"\" at "+E)}else"name"===j||"{"===j||"&"===j?U=!0:"="===j&&m(T)}if(k(),P=d.pop())throw new Error("Unclosed section \""+P[1]+"\" at "+S.pos);return function(e){for(var t,r=[],n=r,i=[],o=0,a=e.length;o<a;++o)switch((t=e[o])[0]){case"#":case"^":n.push(t),i.push(t),n=t[4]=[];break;case"/":i.pop()[5]=t[2],n=i.length>0?i[i.length-1][4]:r;break;default:n.push(t);}return r}(function(e){for(var t,r,n=[],i=0,o=e.length;i<o;++i)(t=e[i])&&("text"===t[0]&&r&&"text"===r[0]?(r[1]+=t[1],r[3]=t[3]):(n.push(t),r=t));return n}(g))}(e,r)),a},g.prototype.render=function(e,t,r,n){var i=this.parse(e,n),o=t instanceof d?t:new d(t,void 0);return this.renderTokens(i,o,r,e,n)},g.prototype.renderTokens=function(e,t,r,n,i){for(var o,a,s,u="",p=0,c=e.length;p<c;++p)s=void 0,"#"===(a=(o=e[p])[0])?s=this.renderSection(o,t,r,n):"^"===a?s=this.renderInverted(o,t,r,n):">"===a?s=this.renderPartial(o,t,r,i):"&"===a?s=this.unescapedValue(o,t):"name"===a?s=this.escapedValue(o,t):"text"===a&&(s=this.rawValue(o)),void 0!==s&&(u+=s);return u},g.prototype.renderSection=function(e,n,i,o){var a=this,s="",u=n.lookup(e[1]);if(u){if(t(u))for(var p=0,c=u.length;p<c;++p)s+=this.renderTokens(e[4],n.push(u[p]),i,o);else if("object"==typeof u||"string"==typeof u||"number"==typeof u)s+=this.renderTokens(e[4],n.push(u),i,o);else if(r(u)){if("string"!=typeof o)throw new Error("Cannot use higher-order sections without the original template");null!=(u=u.call(n.view,o.slice(e[3],e[5]),function(e){return a.render(e,n,i)}))&&(s+=u)}else s+=this.renderTokens(e[4],n,i,o);return s}},g.prototype.renderInverted=function(e,r,n,i){var o=r.lookup(e[1]);if(!o||t(o)&&0===o.length)return this.renderTokens(e[4],r,n,i)},g.prototype.indentPartial=function(e,t,r){for(var n=t.replace(/[^ \t]/g,""),i=e.split("\n"),o=0;o<i.length;o++)i[o].length&&(o>0||!r)&&(i[o]=n+i[o]);return i.join("\n")},g.prototype.renderPartial=function(e,t,n,i){if(n){var o=r(n)?n(e[1]):n[e[1]];if(null!=o){var a=e[6],s=e[5],u=e[4],p=o;return 0==s&&u&&(p=this.indentPartial(o,u,a)),this.renderTokens(this.parse(p,i),t,n,p)}}},g.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(null!=r)return r},g.prototype.escapedValue=function(e,t){var r=t.lookup(e[1]);if(null!=r)return w.escape(r)},g.prototype.rawValue=function(e){return e[1]};var w={name:"mustache.js",version:"3.2.1",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,to_html:void 0,Scanner:void 0,Context:void 0,Writer:void 0},y=new g;return w.clearCache=function(){return y.clearCache()},w.parse=function(e,t){return y.parse(e,t)},w.render=function(e,r,n,i){if("string"!=typeof e)throw new TypeError("Invalid template! Template should be a \"string\" but \""+(t(o=e)?"array":typeof o)+"\" was given as the first argument for mustache#render(template, view, partials)");var o;return y.render(e,r,n,i)},w.to_html=function(e,t,n,i){var o=w.render(e,t,n);if(!r(i))return o;i(o)},w.escape=function(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return u[e]})},w.Scanner=v,w.Context=d,w.Writer=g,w});var d={props:{endpoints:Object,block:Object,fieldGroup:Object,index:Number,columnsCount:Number,pageUid:String,pageId:String,encodedPageId:String,styles:String,script:String,parentPath:String,canDuplicate:Boolean},components:{BuilderPreview:a},mounted:function(){var e=this;this.block._uid||(this.block._uid=this.block._key+"_"+new Date().valueOf()+"_"+this._uid),this.activeFieldSet||(this.activeFieldSet=this.fieldSets[0].key),null!=this.block.expandedInitially&&(this.expanded=this.block.expandedInitially,delete this.block.expandedInitially),this.block.showPreviewInitially&&(this.showPreview=this.block.showPreviewInitially,delete this.block.showPreviewInitially),this.block.activeFieldSetInitially&&(this.activeFieldSet=this.block.activeFieldSetInitially,delete this.block.activeFieldSetInitially),this.block.isNew&&(this.isNew=!0,window.requestAnimationFrame(function(){e.isNew=!1,delete e.block.isNew}));var i=JSON.parse(localStorage.getItem(this.localUiStateKey));i&&null!==i.expanded&&(this.expanded=i.expanded),this.fieldGroup.defaultView&&"default"!=this.fieldGroup.defaultView&&!this.isNew?"preview"==this.fieldGroup.defaultView?this.showPreview=!0:this.activeFieldSet=this.fieldGroup.defaultView:i?(this.showPreview=i.showPreview,this.activeFieldSet=i.activeFieldSet):this.storeLocalUiState(),this.fieldGroup.preview&&this.showPreview&&this.expanded&&this.displayPreview(this.fieldGroup.preview)},data:function(){return{pending:!0,activeFieldSet:null,expanded:!0,isNew:!1,previewFrameContent:null,previewHeight:0,previewStored:!1,previewMarkup:"",showPreview:!1}},computed:{localUiStateKey:function(){return"kBuilder.uiState.".concat(this.block._uid)},extendedUid:function(){return this.pageId.replace("/","-")+"-"+this._uid},previewUrl:function(){return this.previewStored?"kirby-builder-preview/"+this.extendedUid+"?"+this.objectToGetParams(this.fieldGroup.preview)+"&pageid="+this.pageId:null},blockPath:function(){return this.parentPath+"+"+this.block._key},fieldSets:function(){var e=[];if(this.fieldGroup.tabs){for(var i in this.fieldGroup.tabs)if(this.fieldGroup.tabs.hasOwnProperty(i)){var t=this.fieldGroup.tabs[i];e.push(this.newFieldSet(t,i,this.block))}}else this.fieldGroup.fields&&e.push(this.newFieldSet(this.fieldGroup,"content",this.block,"edit",this.$t("edit")));return e},title:function(){var $gZU7$$interop$default=o(h);return this.fieldGroup.label?$gZU7$$interop$default.d.render(this.fieldGroup.label,this.block):this.fieldGroup.name}},methods:{onBlockInput:function(e){this.$emit("input",this.val)},displayPreview:function(){var e=this;this.showPreview=!0,this.expanded=!0;var i={preview:this.fieldGroup.preview,blockContent:this.block,block:this.fieldGroup,blockUid:this.extendedUid,pageid:this.pageId};this.$api.post("kirby-builder/rendered-preview",i).then(function(i){e.previewMarkup=i.preview,e.activeFieldSet=null,e.$refs.preview.resize()}),this.storeLocalUiState()},displayFieldSet:function(e){this.showPreview=!1,this.activeFieldSet=e,this.previewHeight=0,this.storeLocalUiState()},onPreviewLoaded:function(e){this.previewHeight=e.detail.height,this.activeFieldSet=null},toggleExpand:function(e){this.expanded="boolean"==typeof e?e:!this.expanded,this.expanded&&this.showPreview&&this.displayPreview(),this.storeLocalUiState()},newFieldSet:function(e,i,t,l,s){var n=this;Object.keys(e.fields).forEach(function(i){var t=n.endpoints.model;"blocktext".split(",").indexOf(i)>=0?e.fields[i].endpoints={field:"".concat(t,"/fields/").concat("text"),model:t,section:n.endpoints.section}:e.fields[i].endpoints={field:"kirby-builder/".concat(t,"/fields/").concat(n.blockPath,"+").concat(e.fields[i].name),model:t,section:n.endpoints.section},e.fields[i].parentPath=n.blockPath});var o={fields:e.fields,key:i,model:t,icon:l||e.icon||null,label:s||e.label||null};return o},objectToGetParams:function(e){return Object.keys(e).map(function(i){return i+"="+e[i]}).join("&")},storeLocalUiState:function(){var e={expanded:this.expanded,showPreview:this.showPreview,activeFieldSet:this.activeFieldSet};localStorage.setItem(this.localUiStateKey,JSON.stringify(e))},tabIcon:function(e){return e?e.indexOf("/")>-1&&e.indexOf(".")>-1?null:e:null},tabImage:function(e){return e&&e.indexOf("/")>-1&&e.indexOf(".")>-1?e:null}}};if(typeof d==="function"){d=d.options}Object.assign(d,function(){var render=function(){var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c("div",{class:["kBuilderBlock","kBuilderBlock--col-"+_vm.columnsCount,"kBuilderBlock--type-"+_vm.block._key,{"kBuilderBlock--previewMode":_vm.showPreview&&_vm.expanded},{"kBuilderBlock--expanded":_vm.expanded},{"kBuilderBlock--pending":_vm.isNew},{"kBuilderBlock--collapsed":!_vm.expanded},{"kBuilderBlock--editMode":!_vm.showPreview&&_vm.expanded}]},[_c("div",{class:"kBuilderBlock__header kBuilderBlock__header--col-"+_vm.columnsCount},[_c("k-icon",{class:"kBuilder__dragDropHandle kBuilder__dragDropHandle--col-"+_vm.columnsCount,attrs:{"type":"sort"}}),_vm._v(" "),_c("span",{staticClass:"kBuilderBlock__label",on:{"click":_vm.toggleExpand}},[_c("k-icon",{staticClass:"kBuilderBlock__expandedIcon",class:{"kBuilderBlock__expandedIcon--expanded":_vm.expanded},attrs:{"type":"angle-down"}}),_vm._v(" "),_c("span",{domProps:{"innerHTML":_vm._s(_vm.title)}})],1),_vm._v(" "),_c("div",{staticClass:"kBuilderBlock__actions"},[_c("k-button-group",{staticClass:"kBuilderBlock__actionsGroup"},[_vm._l(_vm.fieldSets,function(fieldSet){return _vm.fieldSets.length>1||_vm.fieldGroup.preview?_c("k-button",{key:"showFierldSetButton-"+_vm._uid+fieldSet.key,staticClass:"kBuilderBlock__actionsButton",class:{"kBuilderBlock__actionsButton--active":_vm.activeFieldSet==fieldSet.key&&_vm.expanded},attrs:{"icon":_vm.tabIcon(fieldSet.icon),"image":_vm.tabImage(fieldSet.icon)},on:{"click":function($event){_vm.displayFieldSet(fieldSet.key);_vm.toggleExpand(true)}}},[_vm._v(_vm._s(fieldSet.label))]):_vm._e()}),_vm._v(" "),_vm.fieldGroup.preview?_c("k-button",{staticClass:"kBuilderBlock__actionsButton",class:{"kBuilderBlock__actionsButton--active":_vm.showPreview&&_vm.expanded},attrs:{"icon":"preview"},on:{"click":function($event){return _vm.displayPreview()}}},[_vm._v(_vm._s(_vm.$t("builder.preview")))]):_vm._e()],2),_vm._v(" "),_c("div",{staticClass:"kBuilderBlock__control"},[_c("k-dropdown",{staticClass:"kBuilderBlock__actionsDropDown"},[_c("k-button",{staticClass:"kBuilderBlock__actionsButton",attrs:{"icon":"dots"},on:{"click":function($event){return _vm.$refs["blockActions"].toggle()}}}),_vm._v(" "),_c("k-dropdown-content",{ref:"blockActions",staticClass:"kBuilderBlock__actionsDropDownContent",attrs:{"align":"right"}},[_vm.canDuplicate?_c("k-dropdown-item",{attrs:{"icon":"copy"},on:{"click":function($event){return _vm.$emit("clone",_vm.index,_vm.showPreview,_vm.expanded,_vm.activeFieldSet)}}},[_vm._v(_vm._s(_vm.$t("builder.clone")))]):_vm._e(),_vm._v(" "),_c("k-dropdown-item",{attrs:{"icon":"trash"},on:{"click":function($event){return _vm.$emit("delete",_vm.index)}}},[_vm._v(_vm._s(_vm.$t("delete")))])],1)],1)],1)],1)],1),_vm._v(" "),_c("div",{directives:[{name:"show",rawName:"v-show",value:_vm.expanded,expression:"expanded"}],staticClass:"kBuilderBlock__content"},[_vm.fieldGroup.preview?_c("builder-preview",{directives:[{name:"show",rawName:"v-show",value:_vm.showPreview,expression:"showPreview"}],ref:"preview",attrs:{"markup":_vm.previewMarkup,"styles":_vm.styles,"index":_vm.index,"script":_vm.script}}):_vm._e(),_vm._v(" "),_vm._l(_vm.fieldSets,function(fieldSet){return _vm.activeFieldSet===fieldSet.key?_c("k-fieldset",_vm._g({directives:[{name:"show",rawName:"v-show",value:!_vm.showPreview,expression:"!showPreview"}],key:fieldSet.key+_vm._uid,staticClass:"kBuilderBlock__form",attrs:{"value":{},"fields":fieldSet.fields,"validate":true},model:{value:fieldSet.model,callback:function($$v){_vm.$set(fieldSet,"model",$$v)},expression:"fieldSet.model"}},_vm.$listeners)):_vm._e()})],2)])};var staticRenderFns=[];return{render:render,staticRenderFns:staticRenderFns,_compiled:true,_scopeId:null,functional:undefined}}());var I=arguments[0];var J,K,m,L,M,N,O,P,u,Q,R,v,S,T,w,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,x,ua,va,wa,xa,ya,za,Aa,Ba,y,Ca,z,Da,Ea,A,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,_a,ab,bb;function B(t,$,e){return $ in t?Object.defineProperty(t,$,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[$]=e,t}function i(){return(i=Object.assign||function(t){for(var $=1;$<arguments.length;$++){var e=arguments[$];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t}).apply(this,arguments)}function C(t){for(var $=1;$<arguments.length;$++){var e=null!=arguments[$]?arguments[$]:{},r=Object.keys(e);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(e).filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.forEach(function($){B(t,$,e[$])})}return t}function c(t,$,e){t.addEventListener($,e,!m&&u)}function b(t,$,e){var r=t&&t.style;if(r){if(void 0===e)return document.defaultView&&document.defaultView.getComputedStyle?e=document.defaultView.getComputedStyle(t,""):t.currentStyle&&(e=t.currentStyle),void 0===$?e:e[$];$ in r||-1!==$.indexOf("webkit")||($="-webkit-"+$),r[$]=e+("string"==typeof e?"":"px")}}function f(t,$){var e="";if("string"==typeof t)e=t;else do{var r=b(t,"transform");r&&"none"!==r&&(e=r+" "+e)}while(!$&&(t=t.parentNode));var a=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return a&&new a(e)}function D(){var t=document.scrollingElement;return t||document.documentElement}function p(t,$,e,r,a){if(t.getBoundingClientRect||t===window){var o,n,l,i,s,v,I;if(t!==window&&t!==D()?(n=(o=t.getBoundingClientRect()).top,l=o.left,i=o.bottom,s=o.right,v=o.height,I=o.width):(n=0,l=0,i=window.innerHeight,s=window.innerWidth,v=window.innerHeight,I=window.innerWidth),($||e)&&t!==window&&(a=a||t.parentNode,!m))do{if(a&&a.getBoundingClientRect&&("none"!==b(a,"transform")||e&&"static"!==b(a,"position"))){var c=a.getBoundingClientRect();n-=c.top+parseInt(b(a,"border-top-width")),l-=c.left+parseInt(b(a,"border-left-width")),i=n+o.height,s=l+o.width;break}}while(a=a.parentNode);if(r&&t!==window){var H=f(a||t),d=H&&H.a,u=H&&H.d;H&&(i=(n/=u)+(v/=u),s=(l/=d)+(I/=d))}return{top:n,left:l,bottom:i,right:s,width:I,height:v}}}function E(t,$){for(var e in t)if(t.hasOwnProperty(e))for(var r in $)if($.hasOwnProperty(r)&&$[r]===t[e][r])return Number(e);return-1}function j(t,$){return Math.round(t.top)===Math.round($.top)&&Math.round(t.left)===Math.round($.left)&&Math.round(t.height)===Math.round($.height)&&Math.round(t.width)===Math.round($.width)}function F(){var t,$=[];return{captureAnimationState:function(){($=[],this.options.animation)&&[].slice.call(this.el.children).forEach(function(t){if("none"!==b(t,"display")&&t!==n.ghost){$.push({target:t,rect:p(t)});var e=C({},$[$.length-1].rect);if(t.thisAnimationDuration){var r=f(t,!0);r&&(e.top-=r.f,e.left-=r.e)}t.fromRect=e}})},addAnimationState:function(t){$.push(t)},removeAnimationState:function(t){$.splice(E($,{target:t}),1)},animateAll:function(e){var r=this;if(!this.options.animation)return clearTimeout(t),void("function"==typeof e&&e());var a=!1,o=0;$.forEach(function(t){var $=0,e=t.target,n=e.fromRect,l=p(e),i=e.prevFromRect,s=e.prevToRect,v=t.rect,I=f(e,!0);I&&(l.top-=I.f,l.left-=I.e),e.toRect=l,e.thisAnimationDuration&&j(i,l)&&!j(n,l)&&(v.top-l.top)/(v.left-l.left)==(n.top-l.top)/(n.left-l.left)&&($=H(v,i,s,r.options)),j(l,n)||(e.prevFromRect=n,e.prevToRect=l,$||($=r.options.animation),r.animate(e,v,l,$)),$&&(a=!0,o=Math.max(o,$),clearTimeout(e.animationResetTimer),e.animationResetTimer=setTimeout(function(){e.animationTime=0,e.prevFromRect=null,e.fromRect=null,e.prevToRect=null,e.thisAnimationDuration=null},$),e.thisAnimationDuration=$)}),clearTimeout(t),a?t=setTimeout(function(){"function"==typeof e&&e()},o):"function"==typeof e&&e(),$=[]},animate:function(t,$,e,r){if(r){b(t,"transition",""),b(t,"transform","");var a=f(this.el),o=a&&a.a,n=a&&a.d,l=($.left-e.left)/(o||1),i=($.top-e.top)/(n||1);t.animatingX=!!l,t.animatingY=!!i,b(t,"transform","translate3d("+l+"px,"+i+"px,0)"),G(t),b(t,"transition","transform "+r+"ms"+(this.options.easing?" "+this.options.easing:"")),b(t,"transform","translate3d(0,0,0)"),"number"==typeof t.animated&&clearTimeout(t.animated),t.animated=setTimeout(function(){b(t,"transition",""),b(t,"transform",""),t.animated=!1,t.animatingX=!1,t.animatingY=!1},r)}}}}function G(t){return t.offsetWidth}function H(t,$,e,r){return Math.sqrt(Math.pow($.top-t.top,2)+Math.pow($.left-t.left,2))/Math.sqrt(Math.pow($.top-e.top,2)+Math.pow($.left-e.left,2))*r.animation}function n(t,$){if(!t||!t.nodeType||1!==t.nodeType)throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(t));this.el=t,this.options=$=i({},$),t[v]=this;var e={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(t.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return z(t,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(t,$){t.setData("Text",$.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:!1!==n.supportPointer&&"PointerEvent"in window,emptyInsertThreshold:5};for(var r in w.initializePlugins(this,t,e),e)!(r in $)&&($[r]=e[r]);for(var a in A($),this)"_"===a.charAt(0)&&"function"==typeof this[a]&&(this[a]=this[a].bind(this));this.nativeDraggable=!$.forceFallback&&y,this.nativeDraggable&&(this.options.touchStartThreshold=1),$.supportPointer?c(t,"pointerdown",this._onTapStart):(c(t,"mousedown",this._onTapStart),c(t,"touchstart",this._onTapStart)),this.nativeDraggable&&(c(t,"dragover",this),c(t,"dragenter",this)),x.push(this.el),$.store&&$.store.get&&this.sort($.store.get(this)||[]),i(this,F())}var e={props:{counter:[Boolean,Object],disabled:Boolean,endpoints:Object,help:String,input:[String,Number],name:[String,Number],required:Boolean,type:String,value:{type:String,default:[]},fieldsets:Object,columns:Number,max:Number,label:String,preview:Object,pageId:String,pageUid:String,encodedPageId:String,cssUrls:String,jsUrls:String,parentPath:String},components:{BuilderBlock:d},mounted:function(){for(var t=this,e=function(){var e=l(i[n],2),o=e[0],r=e[1];fetch("/"+r.replace(/^\/+/g,"")).then(function(t){return t.text()}).then(function(e){t.$set(t.cssContents,o,e)})},n=0,i=Object.entries(this.cssUrls);n<i.length;n++)e();for(var o=function(){var e=l(a[r],2),n=e[0],i=e[1];fetch("/"+i.replace(/^\/+/g,"")).then(function(t){return t.text()}).then(function(e){t.$set(t.jsContents,n,e)})},r=0,a=Object.entries(this.jsUrls);r<a.length;r++)o()},data:function(){return{dragging:!1,toggle:!0,targetPosition:null,lastUniqueKey:0,cssContents:{},jsContents:{},dialogOpen:!1}},computed:{classObject:function(){var t={};return t["kBuilder--col-"+this.columnsCount]=!0,t["kBuilder--dragging"]=this.dragging,t},path:function(){return this.parentPath?"".concat(this.parentPath,"+").concat(this.name):this.name},columnsCount:function(){return this.columns?this.columns:"1"},columnWidth:function(){return this.columns?"1/"+this.columns:"1/1"},draggableOptions:function(){return{group:this._uid,handle:".kBuilder__dragDropHandle",forceFallback:!0,fallbackClass:"sortable-fallback",fallbackOnBody:!0,scroll:document.querySelector(".k-panel-view")}},blockCount:function(){return this.value.length},fieldsetCount:function(){return Object.keys(this.fieldsets).length},fieldsetKeys:function(){return Object.keys(this.fieldsets)},addBlockButtonLabel:function(){return this.$t("add")},supportedBlockTypes:function(){return Object.keys(this.fieldsets)}},methods:{onBlockInput:function(t){this.$emit("input",this.value)},onBlockMoved:function(t){this.$emit("input",this.value)},onBlockAdded:function(t){this.$emit("input",this.value)},onBlockRemoved:function(t){this.$emit("input",this.value)},onDragEnd:function(t){this.dragging=!1},onMove:function(t){return this.$root.$emit("blockMoved"),t.relatedContext.index!=this.value.length+1},onStartDrag:function(t){this.dragging=!0;var e=t.item.getElementsByClassName("kBuilderPreview__frame")[0];if(e){var n=e.contentWindow.document,i=document.getElementsByClassName("sortable-drag")[0].getElementsByClassName("kBuilderPreview__frame")[0].contentWindow.document;i.open(),i.write(n.documentElement.innerHTML),i.close()}},onClickAddBlock:function(t){this.targetPosition=t,1==this.fieldsetCount?this.addBlock(this.fieldsetKeys[0]):this.$refs.dialog.open()},onOpenDialog:function(){this.dialogOpen=!0},onCloseDialog:function(){this.dialogOpen=!1},addBlock:function(t){var e=null==this.targetPosition?this.value.length:this.targetPosition,n=this.fieldsets[t];this.value.splice(e,0,this.getBlankContent(t,n)),this.value[e].isNew=!0,this.$emit("input",this.value),this.$nextTick(function(){this.$emit("input",this.value)}),this.targetPosition=null,this.dialogOpen&&this.$refs.dialog.close()},cloneBlock:function(t,e,n,i){var o=JSON.parse(JSON.stringify(this.value[t]));this.deepRemoveProperty(o,"_uid"),this.value.splice(t+1,0,o);var r=this.value[t+1];r.uniqueKey=this.lastUniqueKey++,null!=e&&(r.showPreviewInitially=e),null!=n&&(r.expandedInitially=n),i&&(r.activeFieldSetInitially=i),r.isNew=!0,this.$emit("input",this.value),this.$nextTick(function(){this.$emit("input",this.value)})},getBlankContent:function(t,e){var n={_key:t};if(e.fields)Object.keys(e.fields).forEach(function(t){n[t]=e.fields[t].value||e.fields[t].default||null});else if(e.tabs)for(var i in e.tabs)e.tabs.hasOwnProperty(i)&&function(){var t=e.tabs[i];Object.keys(t.fields).forEach(function(e){n[e]=t.fields[e].value||t.fields[e].default||null})}();return n},deleteBlock:function(t){this.clearLocalUiStates(this.value[t]),this.value.splice(t,1),this.$emit("input",this.value)},deepRemoveProperty:function(t,e){var n=this;Object.keys(t).forEach(function(i){i===e?delete t[i]:t[i]&&"object"===k(t[i])&&n.deepRemoveProperty(t[i],e)})},clearLocalUiStates:function(t){for(var e in t)if(t.hasOwnProperty(e)){t[e];"_uid"===e?localStorage.removeItem("kBuilder.uiState.".concat(t[e])):"object"===k(t[e])&&this.clearLocalUiStates(t[e])}}}};if(typeof e==="function"){e=e.options}Object.assign(e,function(){var render=function(){var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c("k-field",{staticClass:"kBuilder",class:_vm.classObject,attrs:{"label":_vm.label}},[_c("k-draggable",{staticClass:"kBuilder__blocks k-grid",attrs:{"move":_vm.onMove,"list":_vm.value,"options":_vm.draggableOptions},on:{"update":_vm.onBlockMoved,"add":_vm.onBlockAdded,"remove":_vm.onBlockRemoved,"end":_vm.onDragEnd}},[_vm._l(_vm.value,function(blockValue,index){return _c("k-column",{key:blockValue._uid,staticClass:"kBuilder__column",attrs:{"width":_vm.columnWidth}},[!_vm.max||_vm.blockCount<_vm.max?_c("div",{staticClass:"kBuilder__inlineAddButton",class:{"kBuilder__inlineAddButton--horizontal":_vm.columnsCount==1,"kBuilder__inlineAddButton--vertical":_vm.columnsCount>1},on:{"click":function($event){return _vm.onClickAddBlock(index)}}}):_vm._e(),_vm._v(" "),_c("builder-block",{attrs:{"page-id":_vm.pageId,"page-uid":_vm.pageUid,"encoded-page-id":_vm.encodedPageId,"endpoints":_vm.endpoints,"block":blockValue,"fieldGroup":_vm.fieldsets[blockValue._key],"index":index,"columns-count":_vm.columnsCount,"styles":_vm.cssContents[blockValue._key],"script":_vm.jsContents[blockValue._key],"parentPath":_vm.path,"canDuplicate":!_vm.max||_vm.blockCount<_vm.max},on:{"input":_vm.onBlockInput,"clone":_vm.cloneBlock,"delete":_vm.deleteBlock}}),_vm._v(" "),_vm.columnsCount%index==0&&_vm.columnsCount>1&&(!_vm.max||_vm.blockCount<_vm.max)?_c("div",{staticClass:"kBuilder__inlineAddButton kBuilder__inlineAddButton--vertical kBuilder__inlineAddButton--after",on:{"click":function($event){return _vm.onClickAddBlock(index+1)}}}):_vm._e()],1)}),_vm._v(" "),!_vm.max||_vm.blockCount<_vm.max?_c("k-column",{attrs:{"width":_vm.columnWidth}},[_c("k-button",{staticClass:"kBuilder__addButton",attrs:{"icon":"add"},on:{"click":function($event){return _vm.onClickAddBlock()}}},[_vm._v(_vm._s(_vm.addBlockButtonLabel))])],1):_vm._e()],2),_vm._v(" "),_c("k-dialog",{ref:"dialog",staticClass:"kBuilder__dialog",on:{"open":_vm.onOpenDialog,"close":_vm.onCloseDialog}},[_c("k-list",_vm._l(_vm.fieldsets,function(value,key){return _c("k-list-item",{key:key,class:["kBuilder__addBlockButton","kBuilder__addBlockButton--"+key],attrs:{"text":value.name||value.label},on:{"click":function($event){return _vm.addBlock(key)}}},[_c("template",{slot:"options"},[_c("k-icon",{staticClass:"kBuilder__addBlockButtonIcon",attrs:{"type":"add"}})],1)],2)}),1)],1)],1)};var staticRenderFns=[];return{render:render,staticRenderFns:staticRenderFns,_compiled:true,_scopeId:null,functional:undefined}}());panel.plugin("timoetting/k-builder",{fields:{builder:e}});})();